<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Appointments</title>
<style>
/* --- GENERAL STYLING --- */
body {
  color: white;
  background-color: #141B34;
  font-family: sans-serif;
  margin: 0;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #141B34;
  border-bottom: 1px solid white;
  padding: 10px 20px;
}
header h1 { margin:0; }
nav ul {
  list-style-type: none;
  display: flex; 
  margin:0;
  padding:0;
}
nav li { margin-left: 20px; }
nav a { color: white; text-decoration: none; }
nav a:hover { text-decoration: underline; }

.appointments { padding: 20px; text-align: center; }
.schedule-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 20px;
  margin-top: 20px;
  transition: transform 0.36s ease, opacity 0.36s ease;
  will-change: transform, opacity;
}
.day {
  background-color: #1F2A52;
  border-radius: 8px;
  padding: 15px;
  position: relative;
}
.day h3 {
  border-bottom: 1px solid #444;
  padding-bottom: 8px;
  margin-bottom: 10px;
}
.appointment-container {
  position: relative;
  min-height: 200px;
}
.appointment {
  position: absolute;
  background-color: #2D3A6A;
  border-radius: 8px;
  padding: 10px;
  text-align: left;
  cursor: pointer;
  transition: background-color 0.3s, transform 0.2s;
  overflow: hidden;
  box-sizing: border-box;
}
.appointment:hover {
  background-color: #3E4A8A;
  transform: scale(1.03);
}
.appointment span { font-weight: bold; display: block; }
.appointment p { margin: 2px 0 0; font-size: 0.9em; color: #d0d8ff; }

/* --- NEW: Visual indicator for overlapping appointments --- */
.appointment.overlapping {
  border: 2px solid #ff7676;
  box-shadow: 0 0 8px rgba(255, 100, 100, 0.8);
}

.add-btn, #prevWeek, #nextWeek {
  background-color: #3E4A8A;
  color: white;
  border: none;
  border-radius: 6px;
  padding: 8px 12px;
  margin-top: 10px;
  cursor: pointer;
  font-weight: bold;
  width: 100%;
  transition: background-color 0.3s, transform 0.2s;
}
.add-btn:hover, #prevWeek:hover, #nextWeek:hover {
  background-color: #4E5ABB;
  transform: scale(1.03);
}
.week-nav {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  gap: 20px;
}
.week-nav button { width: auto; padding: 10px 20px; }

.modal {
  display: none;
  position: fixed;
  z-index: 10;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
}
.modal-content {
  background-color: #1F2A52;
  margin: 10% auto;
  padding: 20px;
  border-radius: 10px;
  width: 300px;
  color: white;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
}
.modal-content h3 { margin-top:0; text-align:center; border-bottom:1px solid #555; padding-bottom:8px;}
.modal-content label { display:block; margin-top:10px; text-align:left; }
.modal-content input { width:100%; padding:8px; margin-top:5px; border:none; border-radius:5px; }
.submit-btn { width:100%; margin-top:15px; padding:10px; border:none; border-radius:6px; background-color:#3E4A8A; cursor:pointer; font-weight:bold; }
.submit-btn:hover { background-color:#4E5ABB; }

.close { color:#aaa; float:right; font-size:24px; font-weight:bold; cursor:pointer; }
.close:hover { color:white; }

footer { text-align:center; padding:10px; background:#141B34; border-top:1px solid white; margin-top:20px; }

/* --- WEEK TRANSITION EFFECT (robust) --- */
.schedule-grid.slide-out-next  { transform: translateX(-60px); opacity: 0; }
.schedule-grid.slide-out-prev  { transform: translateX(60px);  opacity: 0; }
.schedule-grid.slide-in-next   { transform: translateX(60px);  opacity: 0; }
.schedule-grid.slide-in-prev   { transform: translateX(-60px); opacity: 0; }
</style>
</head>
<body>

<header>
  <h1>Appointments</h1>
  <nav>
    <ul> 
      <li><a href="index.html">Log Out</a></li>
      <li><a href="realtorportal.html">Home</a></li>
      <li><a href="realtormessages.html">Messages</a></li>
    </ul>
  </nav>
</header> 

<main>
  <section class="appointments">
    <h2 id="weekLabel"></h2>
    <div class="week-nav">
      <button id="prevWeek">Previous Week</button>
      <button id="nextWeek">Next Week</button>
    </div>
    <div class="schedule-grid">
      <div class="day"><h3>Monday</h3><div class="appointment-container"></div><button class="add-btn">+ Add Appointment</button></div>
      <div class="day"><h3>Tuesday</h3><div class="appointment-container"></div><button class="add-btn">+ Add Appointment</button></div>
      <div class="day"><h3>Wednesday</h3><div class="appointment-container"></div><button class="add-btn">+ Add Appointment</button></div>
      <div class="day"><h3>Thursday</h3><div class="appointment-container"></div><button class="add-btn">+ Add Appointment</button></div>
      <div class="day"><h3>Friday</h3><div class="appointment-container"></div><button class="add-btn">+ Add Appointment</button></div>
    </div>
  </section>
</main>

<!-- Add Appointment Modal -->
<div id="appointmentModal" class="modal">
  <div class="modal-content">
    <span class="close" id="addClose">&times;</span>
    <h3>Add New Appointment</h3>
    <form id="appointmentForm">
      <label for="startTimeInput">Start Time:</label>
      <input type="time" id="startTimeInput" required>

      <label for="endTimeInput">End Time:</label>
      <input type="time" id="endTimeInput" required>

      <label for="addressInput">Address:</label>
      <input type="text" id="addressInput" placeholder="e.g. 123 Main St." required>

      <label for="realtorInput">Realtor Name:</label>
      <input type="text" id="realtorInput" placeholder="e.g. Jane Smith" required>

      <button type="submit" class="submit-btn">Add Appointment</button>
    </form>
  </div>
</div>

<!-- Edit/Delete Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" id="editClose">&times;</span>
    <h3>Edit Appointment</h3>
    <form id="editForm">
      <label>Start Time:</label>
      <input type="time" id="editStartTime" required>

      <label>End Time:</label>
      <input type="time" id="editEndTime" required>

      <label>Address:</label>
      <input type="text" id="editAddress" required>

      <label>Realtor Name:</label>
      <input type="text" id="editRealtor" required>

      <button type="submit" class="submit-btn">Save</button>
      <button type="button" id="deleteBtn" class="submit-btn" style="background-color:#bb3e3e;margin-top:5px;">Delete</button>
    </form>
  </div>
</div>

<footer>
  <small>Â© 2025 VillaVista Co.</small>
</footer>

<script>
/* --- WEEK LOGIC --- */
let currentWeekStart = getStartOfWeek(new Date());

function getStartOfWeek(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Monday as start
  return new Date(d.setDate(diff));
}

const weekLabel = document.getElementById("weekLabel");

function updateWeekLabel() {
  const options = { month:"numeric", day:"numeric", year:"2-digit" };
  const start = currentWeekStart;
  const end = new Date(start);
  end.setDate(start.getDate() + 6);
  weekLabel.innerText = `Week of ${start.toLocaleDateString("en-US", options)} - ${end.toLocaleDateString("en-US", options)}`;
}

/* --- DATA STORAGE --- */
let appointmentsData = {};

/* --- RENDER WEEK APPOINTMENTS --- */
function renderAppointmentsForWeek() {
  const days = document.querySelectorAll(".day");
  const dayNames = ["Monday","Tuesday","Wednesday","Thursday","Friday"];

  days.forEach((dayCol,i) => {
    const container = dayCol.querySelector(".appointment-container");
    container.innerHTML = ""; // Clear old appointments

    const dayDate = new Date(currentWeekStart);
    dayDate.setDate(currentWeekStart.getDate() + i);
    const options = { month: "numeric", day: "numeric", year: "2-digit" };
    const dateStr = dayDate.toLocaleDateString("en-US", options);
    dayCol.querySelector("h3").innerText = `${dayNames[i]} ${dateStr}`;
    const dayStr = dayDate.toISOString().split("T")[0];

    if (appointmentsData[dayStr]) {
      const appts = appointmentsData[dayStr];
      appts.sort((a,b) => a.startTime.localeCompare(b.startTime));

      // overlap check helper
      function overlaps(a, b) {
        const [aH, aM] = a.startTime.split(":").map(Number);
        const [aEH, aEM] = a.endTime.split(":").map(Number);
        const [bH, bM] = b.startTime.split(":").map(Number);
        const [bEH, bEM] = b.endTime.split(":").map(Number);
        const startA = aH * 60 + aM;
        const endA = aEH * 60 + aEM;
        const startB = bH * 60 + bM;
        const endB = bEH * 60 + bEM;
        return startA < endB && endA > startB;
      }

      // For proper stacking of overlapping groups, we'll compute for each appt how many earlier overlapping "columns" are occupied.
      const columns = []; // array of arrays representing columns of non-overlapping appts

      appts.forEach((appt, index) => {
        // Find a column where this appt does not overlap the last appt in that column
        let colIndex = -1;
        for (let c = 0; c < columns.length; c++) {
          const lastInCol = columns[c][columns[c].length - 1];
          if (!overlaps(appt, lastInCol)) {
            colIndex = c;
            break;
          }
        }
        if (colIndex === -1) {
          columns.push([appt]);
          colIndex = columns.length - 1;
        } else {
          columns[colIndex].push(appt);
        }
        // store the computed column index on the appointment for rendering (temporary)
        appt._colIndex = colIndex;
      });

      // total columns for this day
      const totalCols = columns.length;

      appts.forEach((appt, index) => {
        const newAppt = document.createElement("div");
        newAppt.classList.add("appointment");
        newAppt.innerHTML = `
          <span>${appt.startTime} - ${appt.endTime}</span>
          <p>${appt.address}</p>
          <p style="font-size:0.8em;color:#aab3ff;">Realtor: ${appt.realtor}</p>
        `;
        newAppt.addEventListener("click", () => openEditModal(dayStr, index));

        // Compute vertical position & height
        const [sH, sM] = appt.startTime.split(":").map(Number);
        const [eH, eM] = appt.endTime.split(":").map(Number);
        const startMinutes = sH * 60 + sM;
        const endMinutes = eH * 60 + eM;
        const top = (startMinutes / (24 * 60)) * 200;
        const height = Math.max(25, ((endMinutes - startMinutes) / (24 * 60)) * 200);
        newAppt.style.top = top + "px";
        newAppt.style.height = height + "px";

        // Horizontal sizing: divide container by totalCols and position based on column
        const col = typeof appt._colIndex === "number" ? appt._colIndex : 0;
        const gapPx = 6; // small gap between columns
        const percentWidth = 100 / totalCols;
        newAppt.style.width = `calc(${percentWidth}% - ${gapPx}px)`;
        newAppt.style.left = `calc(${col * percentWidth}% + ${col * gapPx}px)`;

        // Visual indicator if there is more than one column (i.e., at least one overlap exists)
        if (totalCols > 1) {
          newAppt.classList.add("overlapping");
        }

        container.appendChild(newAppt);

        // cleanup temporary property
        delete appt._colIndex;
      });
    }
  });
}

/* --- WEEK NAV BUTTONS --- */
const prevBtn = document.getElementById("prevWeek");
const nextBtn = document.getElementById("nextWeek");
const scheduleGrid = document.querySelector(".schedule-grid");
let isAnimating = false;

function animateWeekChange(direction) {
  if (isAnimating) return;
  isAnimating = true;
  prevBtn.disabled = nextBtn.disabled = true;
  const outClass  = direction === "next" ? "slide-out-next"  : "slide-out-prev";
  const inClass   = direction === "next" ? "slide-in-next"   : "slide-in-prev";
  scheduleGrid.classList.remove("slide-in-next","slide-in-prev","slide-out-next","slide-out-prev");
  void scheduleGrid.offsetWidth;
  scheduleGrid.classList.add(outClass);
  function handleOutTransition(e) {
    if (e.propertyName !== "transform" && e.propertyName !== "opacity") return;
    scheduleGrid.removeEventListener("transitionend", handleOutTransition);
    if (direction === "next") {
      currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    } else {
      currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    }
    updateWeekLabel();
    renderAppointmentsForWeek();
    scheduleGrid.classList.remove(outClass);
    scheduleGrid.classList.add(inClass);
    void scheduleGrid.offsetWidth;
    requestAnimationFrame(() => {
      scheduleGrid.classList.remove(inClass);
      function handleInTransition(ev) {
        if (ev.propertyName !== "transform" && ev.propertyName !== "opacity") return;
        scheduleGrid.removeEventListener("transitionend", handleInTransition);
        scheduleGrid.classList.remove("slide-in-next","slide-in-prev","slide-out-next","slide-out-prev");
        isAnimating = false;
        prevBtn.disabled = nextBtn.disabled = false;
      }
      scheduleGrid.addEventListener("transitionend", handleInTransition);
    });
  }
  scheduleGrid.addEventListener("transitionend", handleOutTransition);
}
prevBtn.addEventListener("click", () => animateWeekChange("prev"));
nextBtn.addEventListener("click", () => animateWeekChange("next"));

/* --- ADD MODAL LOGIC --- */
const addModal = document.getElementById("appointmentModal");
const addButtons = document.querySelectorAll(".add-btn");
const addClose = document.getElementById("addClose");
const addForm = document.getElementById("appointmentForm");

addButtons.forEach(btn => btn.addEventListener("click", () => {
  addModal.style.display = "block";
  // Determine day index robustly
  const days = Array.from(document.querySelectorAll(".day"));
  const dayIndex = days.indexOf(btn.parentElement);
  addModal.dataset.dayIndex = dayIndex;
}));

addClose.addEventListener("click", () => addModal.style.display = "none");
window.addEventListener("click", e => { if (e.target === addModal) addModal.style.display = "none"; });

addForm.addEventListener("submit", e => {
  e.preventDefault();
  const startTime = document.getElementById("startTimeInput").value;
  const endTime = document.getElementById("endTimeInput").value;
  const address = document.getElementById("addressInput").value;
  const realtor = document.getElementById("realtorInput").value;
  const dayIndex = parseInt(addModal.dataset.dayIndex, 10);
  const dayDate = new Date(currentWeekStart);
  dayDate.setDate(currentWeekStart.getDate() + dayIndex);
  const dayStr = dayDate.toISOString().split("T")[0];
  if (!appointmentsData[dayStr]) appointmentsData[dayStr] = [];
  appointmentsData[dayStr].push({ startTime, endTime, address, realtor });
  addModal.style.display = "none";
  addForm.reset();
  renderAppointmentsForWeek();
});

/* --- EDIT/DELETE MODAL --- */
const editModal = document.getElementById("editModal");
const editClose = document.getElementById("editClose");
const editForm = document.getElementById("editForm");
const editStartTime = document.getElementById("editStartTime");
const editEndTime = document.getElementById("editEndTime");
const editAddress = document.getElementById("editAddress");
const editRealtor = document.getElementById("editRealtor");
const deleteBtn = document.getElementById("deleteBtn");
let editDayStr = null, editIndex = null;

function openEditModal(dayStrParam, indexParam) {
  editDayStr = dayStrParam;
  editIndex = indexParam;
  const appt = appointmentsData[editDayStr][editIndex];
  editStartTime.value = appt.startTime;
  editEndTime.value = appt.endTime;
  editAddress.value = appt.address;
  editRealtor.value = appt.realtor;
  editModal.style.display = "block";
}

editClose.addEventListener("click", () => { editModal.style.display = "none"; });
window.addEventListener("click", e => { if (e.target === editModal) editModal.style.display = "none"; });

editForm.addEventListener("submit", e => {
  e.preventDefault();
  if (editDayStr == null || editIndex == null) return;
  appointmentsData[editDayStr][editIndex] = {
    startTime: editStartTime.value,
    endTime: editEndTime.value,
    address: editAddress.value,
    realtor: editRealtor.value
  };
  editModal.style.display = "none";
  renderAppointmentsForWeek();
});

deleteBtn.addEventListener("click", () => {
  if (editDayStr == null || editIndex == null) return;
  appointmentsData[editDayStr].splice(editIndex, 1);
  // If array becomes empty, remove the key
  if (appointmentsData[editDayStr].length === 0) delete appointmentsData[editDayStr];
  editModal.style.display = "none";
  renderAppointmentsForWeek();
});

/* --- INIT --- */
updateWeekLabel();
renderAppointmentsForWeek();
</script>
</body>
</html>
